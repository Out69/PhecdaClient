package pl.oucik.phecdateam.rebuild.command.impl;

import java.util.Arrays;
import java.util.stream.Collectors;

import pl.oucik.phecdateam.PhecdaClient;
import pl.oucik.phecdateam.rebuild.exception.CommandException;
import pl.oucik.phecdateam.rebuild.exploit.Exploit;
import pl.oucik.phecdateam.rebuild.exploit.argument.ArgumentParser;
import pl.oucik.phecdateam.rebuild.helper.ChatHelper;
import pl.oucik.phecdateam.rebuild.helper.ExecutorHelper;
import pl.oucik.phecdateam.rebuild.command.Command;
import pl.oucik.phecdateam.rebuild.command.CommandInfo;

@CommandInfo(
    alias = "crash",
    description = "Simple crasher for servers",
    usage = ".crash <method/list> <packets>",
    aliases = {"crash", "lag"}
)
public class ExploitCommand extends Command {

  @Override
  public void execute(String... args) throws CommandException {
    if (args.length == 0) {
      throw new CommandException("&cUsage: &4" + getUsage());
    }

    if (args[0].equalsIgnoreCase("list")) {
      ChatHelper.printMessage(
          "&cAvailable methods: &4" + PhecdaClient.INSTANCE.getExploitManager().getExploits().stream()
              .map(Exploit::getName).collect(Collectors.joining(", ")));
    } else if (args[0].equalsIgnoreCase("info") && args.length > 1) {
      Exploit<?> exploit = PhecdaClient.INSTANCE.getExploitManager().getExploit(args[1])
          .orElseThrow(
              () -> new CommandException(String.format("Exploit \"%s\" not found.\n", args[1])));

      ChatHelper.printMessage(
          String.format("&c%s&f: &4%s\n", exploit.getName(), exploit.getDescription()));

    } else {
      Exploit<?> exploit = PhecdaClient.INSTANCE.getExploitManager().getExploit(args[0])
          .orElseThrow(() -> new CommandException(
              "&cCrasher not found! Use &4.crash list &cto see all crashers"));

      Object[] arguments = ArgumentParser.parseArgs(exploit,
          Arrays.copyOfRange(args, 1, args.length));
      ExecutorHelper.submit(() -> exploit.execute(arguments));
    }
  }
}
